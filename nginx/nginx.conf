server {
    listen 80;
    server_name 192.168.0.5;

    # 网站根目录，对应 Docker 容器内的路径
    root /usr/share/nginx/html;
    index index.html index.htm;

    # 处理所有请求
    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        # 将 API 请求代理到我们定义的上游服务
        proxy_pass http://newmoodle_api:8000;

        # 设置必要的代理头信息，让后端应用能获取到真实的客户端信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /aaa/ {
        proxy_pass         http://newmoodle_ws:5000/;
        proxy_redirect     off;

        # Standard headers for proxying and WebSocket
        # 转发客户端原始的 Host 头。$host 变量通常包含主机名和端口（如果非标准端口）
        # $http_host 也可以使用，它只包含客户端发送的 Host 头的值。
        # 在大多数情况下，$host 是更稳健的选择。
        proxy_set_header   Host             $host;

        # 转发客户端的真实 IP 地址
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

        # *** 非常重要：转发 Authorization 头 ***
        # Nginx 默认不会转发 Authorization 头，需要显式设置。
        proxy_set_header   Authorization    $http_authorization; # $http_<header_name_lowercase>

        # Headers required for WebSocket handshake and persistent connection
        proxy_http_version 1.1;
        # 转发客户端发送的 Upgrade 头值
        proxy_set_header Upgrade $http_upgrade;
        # 设置 Connection 头为 "upgrade"，这是 WebSocket 升级必需的
        proxy_set_header Connection "upgrade";

        # 其他标准请求头（如 User-Agent, Sec-Websocket-Version 等）通常Nginx会默认转发
        # 除非你在 http 或 server 块中有 proxy_pass_request_headers off; 指令，
        # 否则它们应该会传递到后端，无需在这里显式设置。
        # 如果需要，可以这样显式设置，但通常是不必要的：
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Sec-Websocket-Version $http_sec_websocket_version;
        proxy_set_header Sec-Websocket-Key $http_sec_websocket_key;
    }
}

server {
    listen 81;
    server_name 192.168.0.5;

    location / {
        # 将请求代理到我们定义的上游服务
        proxy_pass https://moodle:8443;

        # 设置必要的代理头信息，让后端应用能获取到真实的客户端信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 支持 WebSocket (如果你的对话平台需要)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
